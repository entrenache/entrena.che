<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ENTRENA'CHE · Anamnesis</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            carbón: "#121212",
            rojo: "#D32F2F",
            humo: "#F3F4F6",
            plata: "#BFC7D5",
            glass: "rgba(255,255,255,0.08)"
          },
          boxShadow: {
            soft: "0 10px 30px rgba(0,0,0,0.45)",
            glowRed: "0 0 0 1px rgba(211,47,47,0.25), 0 18px 50px rgba(211,47,47,0.12)",
            glowGreen: "0 0 0 1px rgba(34,197,94,0.20), 0 18px 50px rgba(34,197,94,0.10)",
            glowYellow:"0 0 0 1px rgba(234,179,8,0.20), 0 18px 50px rgba(234,179,8,0.10)",
          }
        }
      }
    }
  </script>

  <style>
    /* Impresión pro: solo ficha */
    @media print {
      @page { size: A4; margin: 14mm; }
      html, body { background:#fff !important; }
      body { color:#111 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }

      header, #inicio, #evaluacion, #registro, footer { display:none !important; }
      #printArea { display:block !important; }
      #printArea * { color:#111 !important; }

      .no-break { break-inside: avoid; page-break-inside: avoid; }

      .print-title { font-size: 18pt; font-weight: 800; letter-spacing: 0.08em; }
      .print-sub { font-size: 9.5pt; color:#333 !important; }
      .print-label { font-size: 9pt; color:#444 !important; }
      .print-value { font-size: 10.5pt; font-weight: 700; }
      .print-box { border:1px solid #E5E7EB; border-radius: 10px; padding: 10px 12px; }
      .print-section { border:1px solid #E5E7EB; border-radius: 12px; padding: 12px; }

      .chip { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-weight:800; font-size:10pt; border:1px solid #e5e7eb; }
      .dot { width:10px; height:10px; border-radius:999px; }
      .chip-red { background:#FEE2E2; border-color:#FCA5A5; }
      .chip-yellow { background:#FEF3C7; border-color:#FCD34D; }
      .chip-green { background:#DCFCE7; border-color:#86EFAC; }
      .dot-red { background:#DC2626; }
      .dot-yellow { background:#F59E0B; }
      .dot-green { background:#16A34A; }

      .sigline { border-top: 1px solid #D1D5DB; padding-top: 8px; margin-top: 34px; font-size: 9pt; color:#444 !important; }
    }
  </style>
</head>

<body class="min-h-screen bg-carbón text-humo antialiased">
  <!-- background vibe -->
  <div class="pointer-events-none fixed inset-0 -z-10">
    <div class="absolute inset-0 bg-gradient-to-b from-black via-carbón to-black"></div>
    <div class="absolute -top-24 -left-24 h-80 w-80 rounded-full bg-rojo/20 blur-3xl"></div>
    <div class="absolute top-1/3 -right-24 h-80 w-80 rounded-full bg-emerald-400/10 blur-3xl"></div>
    <div class="absolute bottom-0 left-1/4 h-96 w-96 rounded-full bg-cyan-400/10 blur-3xl"></div>
    <div class="absolute inset-0 opacity-[0.12]"
      style="background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.25) 1px, transparent 0); background-size: 22px 22px;">
    </div>
  </div>

  <!-- Header -->
  <header class="sticky top-0 z-30 border-b border-white/10 bg-black/30 backdrop-blur-xl">
    <div class="mx-auto flex max-w-6xl items-center justify-between px-4 py-4">
      <div class="flex items-center gap-3">
        <img src="logo-entrenache.png" alt="ENTRENA'CHE" class="h-12 w-auto drop-shadow-[0_6px_16px_rgba(211,47,47,0.45)]"/>
        <div class="leading-tight">
          <div class="text-lg font-extrabold tracking-[0.18em]">
            ENTRENA<span class="text-rojo">'</span>CHE
          </div>
          <div class="text-xs text-plata/90 tracking-wide">Fuerza Patagónica · Ciencia Deportiva</div>
        </div>
      </div>

      <nav class="hidden items-center gap-6 md:flex text-sm text-plata">
        <a href="#inicio" class="hover:text-humo transition">Inicio</a>
        <a href="#evaluacion" class="hover:text-humo transition">Evaluación</a>
        <a href="#registro" class="hover:text-humo transition">Registro</a>
      </nav>

      <button id="btnScrollStart"
        class="group inline-flex items-center gap-2 rounded-2xl bg-rojo px-4 py-2 text-sm font-semibold shadow-glowRed hover:brightness-110 active:scale-[0.99] transition">
        <i class="fa-solid fa-play"></i>
        <span>Iniciar</span>
        <i class="fa-solid fa-arrow-right text-white/80 group-hover:translate-x-0.5 transition"></i>
      </button>
    </div>
  </header>

  <!-- Hero -->
  <section id="inicio" class="mx-auto max-w-6xl px-4 pt-12 pb-10">
    <div class="grid gap-10 md:grid-cols-2 md:items-center">
      <div>
        <div class="inline-flex items-center gap-2 rounded-full bg-white/5 px-4 py-2 text-xs text-plata ring-1 ring-white/10">
          <i class="fa-solid fa-shield-heart text-rojo"></i>
          <span>Evaluación Pre-participativa · Gestión de Riesgo</span>
        </div>

        <h1 class="mt-5 text-4xl font-extrabold leading-tight md:text-5xl">
          Tu Entrenamiento Comienza con la <span class="text-rojo">Verdad</span>.
        </h1>
        <p class="mt-4 text-plata text-base md:text-lg leading-relaxed">
          Multi-step + semáforo en vivo + registro de sujetos + impresión premium para archivador.
        </p>

        <div class="mt-8 flex flex-wrap items-center gap-3">
          <button id="btnStart"
            class="relative overflow-hidden rounded-2xl bg-rojo px-6 py-3 font-semibold shadow-glowRed hover:brightness-110 active:scale-[0.99] transition">
            <span class="relative z-10 inline-flex items-center gap-2">
              <i class="fa-solid fa-clipboard-check"></i>
              Iniciar Evaluación
            </span>
            <span class="absolute inset-0 -z-0 animate-pulse bg-white/10"></span>
          </button>

          <button id="btnGoRegistro"
            class="rounded-2xl bg-white/5 px-6 py-3 font-semibold ring-1 ring-white/10 hover:bg-white/10 transition">
            <i class="fa-solid fa-database mr-2 text-emerald-300"></i>
            Ver Registro
          </button>

          <button id="btnDemoFill"
            class="rounded-2xl bg-white/5 px-6 py-3 font-semibold ring-1 ring-white/10 hover:bg-white/10 transition">
            <i class="fa-solid fa-wand-magic-sparkles mr-2 text-cyan-300"></i>
            Demo
          </button>
        </div>
      </div>

      <div class="rounded-3xl bg-glass p-6 ring-1 ring-white/10 shadow-soft backdrop-blur-xl">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="text-sm text-plata">Salida para archivador</div>
            <div class="mt-1 text-xl font-bold">Ficha A4 Pro</div>
            <div class="mt-2 text-sm text-plata leading-relaxed">
              Se imprime solo el resumen, con secciones limpias, chip de riesgo y firmas.
            </div>
          </div>
          <div class="grid h-12 w-12 place-items-center rounded-2xl bg-white/5 ring-1 ring-white/10">
            <i class="fa-solid fa-print text-rojo"></i>
          </div>
        </div>

        <div class="mt-6 grid grid-cols-3 gap-3">
          <div class="rounded-2xl bg-white/5 p-4 ring-1 ring-white/10">
            <div class="text-xs text-plata">ROJO</div>
            <div class="mt-2 flex items-center gap-2 font-semibold">
              <span class="h-2 w-2 rounded-full bg-rojo"></span> Alto
            </div>
          </div>
          <div class="rounded-2xl bg-white/5 p-4 ring-1 ring-white/10">
            <div class="text-xs text-plata">AMARILLO</div>
            <div class="mt-2 flex items-center gap-2 font-semibold">
              <span class="h-2 w-2 rounded-full bg-yellow-300"></span> Medio
            </div>
          </div>
          <div class="rounded-2xl bg-white/5 p-4 ring-1 ring-white/10">
            <div class="text-xs text-plata">VERDE</div>
            <div class="mt-2 flex items-center gap-2 font-semibold">
              <span class="h-2 w-2 rounded-full bg-emerald-400"></span> Bajo
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- App -->
  <section id="evaluacion" class="mx-auto max-w-6xl px-4 pb-10">
    <div class="rounded-3xl bg-glass p-6 md:p-8 ring-1 ring-white/10 shadow-soft backdrop-blur-xl">

      <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div>
          <div class="text-sm text-plata">ENTRENA'CHE · Sistema de Evaluación</div>
          <div class="mt-1 text-2xl font-extrabold tracking-wide">Anamnesis Pre-participativa</div>
        </div>

        <div class="flex items-center gap-3">
          <div class="rounded-2xl bg-black/30 px-4 py-3 ring-1 ring-white/10">
            <div class="text-xs text-plata">Fecha</div>
            <div id="fechaHoy" class="text-sm font-semibold"></div>
          </div>

          <button id="btnReset"
            class="rounded-2xl bg-white/5 px-4 py-3 text-sm font-semibold ring-1 ring-white/10 hover:bg-white/10 transition">
            <i class="fa-solid fa-rotate-right mr-2"></i> Reiniciar
          </button>
        </div>
      </div>

      <!-- Progress -->
      <div class="mt-8">
        <div class="flex items-center justify-between text-xs text-plata">
          <span id="stepLabel">Paso 1 de 3 · Identidad</span>
          <span id="progressPct">33%</span>
        </div>
        <div class="mt-2 h-2 w-full overflow-hidden rounded-full bg-white/5 ring-1 ring-white/10">
          <div id="progressBar" class="h-full w-1/3 rounded-full bg-rojo transition-all duration-500"></div>
        </div>
      </div>

      <form id="anamnesisForm" class="mt-8 space-y-8" autocomplete="off">
        <!-- STEP 1 -->
        <div class="step" data-step="1">
          <div class="flex items-center gap-3">
            <div class="grid h-10 w-10 place-items-center rounded-2xl bg-white/5 ring-1 ring-white/10">
              <i class="fa-solid fa-id-card text-cyan-300"></i>
            </div>
            <div>
              <div class="text-lg font-bold">Identidad</div>
              <div class="text-sm text-plata">Datos básicos del atleta/paciente.</div>
            </div>
          </div>

          <div class="mt-6 grid gap-4 md:grid-cols-3">
            <div class="rounded-2xl bg-black/30 p-4 ring-1 ring-white/10">
              <label class="text-xs text-plata">Nombre</label>
              <input id="nombre" type="text" class="mt-2 w-full rounded-xl bg-white/5 px-4 py-3 text-sm ring-1 ring-white/10 focus:ring-2 focus:ring-rojo outline-none transition" placeholder="Nombre y apellido" required>
            </div>
            <div class="rounded-2xl bg-black/30 p-4 ring-1 ring-white/10">
              <label class="text-xs text-plata">RUT</label>
              <input id="rut" type="text" class="mt-2 w-full rounded-xl bg-white/5 px-4 py-3 text-sm ring-1 ring-white/10 focus:ring-2 focus:ring-rojo outline-none transition" placeholder="12.345.678-9" required>
            </div>
            <div class="rounded-2xl bg-black/30 p-4 ring-1 ring-white/10">
              <label class="text-xs text-plata">Edad</label>
              <input id="edad" type="number" min="0" max="120" class="mt-2 w-full rounded-xl bg-white/5 px-4 py-3 text-sm ring-1 ring-white/10 focus:ring-2 focus:ring-rojo outline-none transition" placeholder="Años" required>
            </div>
          </div>

          <div class="mt-4 grid gap-4 md:grid-cols-2">
            <div class="rounded-2xl bg-black/30 p-4 ring-1 ring-white/10">
              <label class="text-xs text-plata">Contacto</label>
              <input id="contacto" type="text" class="mt-2 w-full rounded-xl bg-white/5 px-4 py-3 text-sm ring-1 ring-white/10 focus:ring-2 focus:ring-rojo outline-none transition" placeholder="+56 9 XXXXXXXX / correo" />
            </div>
            <div class="rounded-2xl bg-black/30 p-4 ring-1 ring-white/10">
              <label class="text-xs text-plata">Notas / Observaciones</label>
              <input id="notas" type="text" class="mt-2 w-full rounded-xl bg-white/5 px-4 py-3 text-sm ring-1 ring-white/10 focus:ring-2 focus:ring-rojo outline-none transition" placeholder="Contexto breve: objetivo, molestias, etc." />
            </div>
          </div>
        </div>

        <!-- STEP 2 -->
        <div class="step hidden" data-step="2">
          <div class="flex items-center gap-3">
            <div class="grid h-10 w-10 place-items-center rounded-2xl bg-white/5 ring-1 ring-white/10">
              <i class="fa-solid fa-heart-pulse text-emerald-300"></i>
            </div>
            <div>
              <div class="text-lg font-bold">Signos Vitales y Antecedentes</div>
              <div class="text-sm text-plata">Registro inicial para orientar carga y seguridad.</div>
            </div>
          </div>

          <div class="mt-6 grid gap-4 md:grid-cols-3">
            <div class="rounded-2xl bg-black/30 p-4 ring-1 ring-white/10">
              <label class="text-xs text-plata">Presión arterial (mmHg)</label>
              <div class="mt-2 grid grid-cols-2 gap-3">
                <input id="paSis" type="number" min="0" class="w-full rounded-xl bg-white/5 px-4 py-3 text-sm ring-1 ring-white/10 focus:ring-2 focus:ring-rojo outline-none transition" placeholder="Sistólica">
                <input id="paDia" type="number" min="0" class="w-full rounded-xl bg-white/5 px-4 py-3 text-sm ring-1 ring-white/10 focus:ring-2 focus:ring-rojo outline-none transition" placeholder="Diastólica">
              </div>
            </div>

            <div class="rounded-2xl bg-black/30 p-4 ring-1 ring-white/10">
              <label class="text-xs text-plata">Frec. cardiaca reposo (lpm)</label>
              <input id="fcr" type="number" min="0" class="mt-2 w-full rounded-xl bg-white/5 px-4 py-3 text-sm ring-1 ring-white/10 focus:ring-2 focus:ring-rojo outline-none transition" placeholder="Ej: 58">
            </div>

            <div class="rounded-2xl bg-black/30 p-4 ring-1 ring-white/10">
              <label class="text-xs text-plata">Peso / Estatura</label>
              <div class="mt-2 grid grid-cols-2 gap-3">
                <input id="peso" type="number" min="0" step="0.1" class="w-full rounded-xl bg-white/5 px-4 py-3 text-sm ring-1 ring-white/10 focus:ring-2 focus:ring-rojo outline-none transition" placeholder="kg">
                <input id="estatura" type="number" min="0" step="0.1" class="w-full rounded-xl bg-white/5 px-4 py-3 text-sm ring-1 ring-white/10 focus:ring-2 focus:ring-rojo outline-none transition" placeholder="cm">
              </div>
            </div>
          </div>

          <div class="mt-6 grid gap-4 md:grid-cols-2">
            <div class="rounded-2xl bg-black/30 p-4 ring-1 ring-white/10">
              <div class="flex items-center justify-between">
                <label class="text-sm font-semibold">Antecedentes relevantes</label>
                <span class="text-xs text-plata">Marca lo que aplique</span>
              </div>

              <div class="mt-4 grid gap-3">
                <label class="flex items-center justify-between rounded-2xl bg-white/5 p-4 ring-1 ring-white/10 hover:bg-white/10 transition">
                  <span class="flex items-center gap-3">
                    <i class="fa-solid fa-pills text-plata"></i>
                    <span class="text-sm">Medicamentos crónicos</span>
                  </span>
                  <input id="meds" type="checkbox" class="h-5 w-5 accent-[#D32F2F]">
                </label>

                <label class="flex items-center justify-between rounded-2xl bg-white/5 p-4 ring-1 ring-white/10 hover:bg-white/10 transition">
                  <span class="flex items-center gap-3">
                    <i class="fa-solid fa-notes-medical text-plata"></i>
                    <span class="text-sm">Diagnóstico médico conocido</span>
                  </span>
                  <input id="diag" type="checkbox" class="h-5 w-5 accent-[#D32F2F]">
                </label>

                <div class="rounded-2xl bg-white/5 p-4 ring-1 ring-white/10">
                  <label class="text-xs text-plata">Detalle (opcional)</label>
                  <input id="detalleAntecedente" type="text" class="mt-2 w-full rounded-xl bg-black/30 px-4 py-3 text-sm ring-1 ring-white/10 focus:ring-2 focus:ring-rojo outline-none transition" placeholder="Ej: asma, lesión previa, cirugía, etc.">
                </div>
              </div>
            </div>

            <div class="rounded-2xl bg-black/30 p-4 ring-1 ring-white/10">
              <div class="flex items-center justify-between">
                <label class="text-sm font-semibold">Hábitos y contexto</label>
                <span class="text-xs text-plata">Orientativo</span>
              </div>

              <div class="mt-4 grid gap-4">
                <div class="rounded-2xl bg-white/5 p-4 ring-1 ring-white/10">
                  <label class="text-xs text-plata">Nivel de actividad actual</label>
                  <select id="actividad" class="mt-2 w-full rounded-xl bg-black/30 px-4 py-3 text-sm ring-1 ring-white/10 focus:ring-2 focus:ring-rojo outline-none transition">
                    <option value="">Seleccionar…</option>
                    <option>Sedentario / muy bajo</option>
                    <option>Activo recreativo</option>
                    <option>Entrena 3-4 días/sem</option>
                    <option>Entrena 5+ días/sem</option>
                    <option>Competitivo</option>
                  </select>
                </div>

                <div class="rounded-2xl bg-white/5 p-4 ring-1 ring-white/10">
                  <label class="text-xs text-plata">Objetivo principal</label>
                  <select id="objetivo" class="mt-2 w-full rounded-xl bg-black/30 px-4 py-3 text-sm ring-1 ring-white/10 focus:ring-2 focus:ring-rojo outline-none transition">
                    <option value="">Seleccionar…</option>
                    <option>Fuerza / Powerbuilding</option>
                    <option>Hipertrofia</option>
                    <option>Salud / recomposición</option>
                    <option>Resistencia aeróbica</option>
                    <option>Rendimiento deportivo</option>
                  </select>
                </div>
              </div>

              <div class="mt-4 rounded-2xl bg-black/30 p-4 ring-1 ring-white/10">
                <div class="flex items-center gap-2 text-xs text-plata">
                  <i class="fa-solid fa-circle-exclamation text-yellow-300"></i>
                  <span>Este formulario no reemplaza evaluación clínica.</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- STEP 3 -->
        <div class="step hidden" data-step="3">
          <div class="flex items-center gap-3">
            <div class="grid h-10 w-10 place-items-center rounded-2xl bg-white/5 ring-1 ring-white/10">
              <i class="fa-solid fa-triangle-exclamation text-rojo"></i>
            </div>
            <div>
              <div class="text-lg font-bold">Semáforo (Preguntas Críticas)</div>
              <div class="text-sm text-plata">Marca síntomas y se calcula el riesgo en tiempo real.</div>
            </div>
          </div>

          <div class="mt-6 grid gap-4 md:grid-cols-3">
            <div class="rounded-2xl bg-black/30 p-4 ring-1 ring-white/10">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold">Banderas Rojas</div>
                <span class="text-xs text-plata">Riesgo Alto</span>
              </div>
              <div class="mt-4 grid gap-3">
                <label class="flex items-center justify-between rounded-2xl bg-white/5 p-4 ring-1 ring-white/10 hover:bg-white/10 transition">
                  <span class="flex items-center gap-3">
                    <i class="fa-solid fa-heart-circle-bolt text-rojo"></i>
                    <span class="text-sm">Dolor de pecho al esfuerzo</span>
                  </span>
                  <input id="dolorPecho" type="checkbox" class="h-5 w-5 accent-[#D32F2F]">
                </label>
                <label class="flex items-center justify-between rounded-2xl bg-white/5 p-4 ring-1 ring-white/10 hover:bg-white/10 transition">
                  <span class="flex items-center gap-3">
                    <i class="fa-solid fa-person-falling-burst text-rojo"></i>
                    <span class="text-sm">Mareos / desmayos</span>
                  </span>
                  <input id="desmayos" type="checkbox" class="h-5 w-5 accent-[#D32F2F]">
                </label>
              </div>
            </div>

            <div class="rounded-2xl bg-black/30 p-4 ring-1 ring-white/10">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold">Banderas Amarillas</div>
                <span class="text-xs text-plata">Riesgo Medio</span>
              </div>
              <div class="mt-4 grid gap-3">
                <label class="flex items-center justify-between rounded-2xl bg-white/5 p-4 ring-1 ring-white/10 hover:bg-white/10 transition">
                  <span class="flex items-center gap-3">
                    <i class="fa-solid fa-bone text-yellow-300"></i>
                    <span class="text-sm">Dolor óseo / articular</span>
                  </span>
                  <input id="dolorArticular" type="checkbox" class="h-5 w-5 accent-[#D32F2F]">
                </label>
                <label class="flex items-center justify-between rounded-2xl bg-white/5 p-4 ring-1 ring-white/10 hover:bg-white/10 transition">
                  <span class="flex items-center gap-3">
                    <i class="fa-solid fa-capsules text-yellow-300"></i>
                    <span class="text-sm">Toma meds presión/corazón</span>
                  </span>
                  <input id="medsCardio" type="checkbox" class="h-5 w-5 accent-[#D32F2F]">
                </label>
              </div>

              <div class="mt-4 rounded-2xl bg-white/5 p-4 ring-1 ring-white/10">
                <label class="text-xs text-plata">Detalle de molestia (opcional)</label>
                <input id="detalleDolor" type="text" class="mt-2 w-full rounded-xl bg-black/30 px-4 py-3 text-sm ring-1 ring-white/10 focus:ring-2 focus:ring-rojo outline-none transition" placeholder="Ej: rodilla derecha, hombro, lumbar...">
              </div>
            </div>

            <div class="rounded-2xl bg-black/30 p-4 ring-1 ring-white/10">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold">Resultado</div>
                <span class="text-xs text-plata">Semáforo</span>
              </div>

              <div id="riskCard" class="mt-4 rounded-2xl bg-white/5 p-4 ring-1 ring-white/10 transition">
                <div class="mt-3 h-2 w-full rounded-full bg-white/10 overflow-hidden">
                  <div id="riskBar" class="h-full w-1/3 bg-emerald-400 transition-all"></div>
                </div>
                <div class="flex items-start justify-between gap-3">
                  <div>
                    <div class="text-xs text-plata">Evaluación de Riesgo</div>
                    <div id="riskTitle" class="mt-1 text-xl font-extrabold">BAJO</div>
                    <div id="riskMsg" class="mt-2 text-sm text-plata leading-relaxed">
                      Apto para entrenamiento intenso.
                    </div>
                  </div>
                  <div class="grid h-12 w-12 place-items-center rounded-2xl bg-black/30 ring-1 ring-white/10">
                    <i id="riskIcon" class="fa-solid fa-circle-check text-emerald-400 text-xl"></i>
                  </div>
                </div>

                <div class="mt-4">
                  <div class="flex items-center justify-between text-xs text-plata">
                    <span>Estado</span>
                    <span id="riskPill" class="inline-flex items-center gap-2 rounded-full bg-emerald-500/15 px-3 py-1 ring-1 ring-emerald-500/25 text-emerald-200 font-semibold">
                      <span class="h-2 w-2 rounded-full bg-emerald-400"></span>
                      VERDE
                    </span>
                  </div>
                </div>
              </div>

              <div class="mt-4 grid gap-3">
                <button id="btnSave" type="button"
                  class="w-full rounded-2xl bg-rojo px-4 py-3 font-semibold shadow-glowRed hover:brightness-110 active:scale-[0.99] transition">
                  <i class="fa-solid fa-floppy-disk mr-2"></i> Guardar en Registro
                </button>

                <button id="btnPrint" type="button"
                  class="w-full rounded-2xl bg-white/5 px-4 py-3 font-semibold ring-1 ring-white/10 hover:bg-white/10 transition">
                  <i class="fa-solid fa-print mr-2 text-emerald-300"></i> Imprimir Ficha
                </button>
              </div>

              <p class="mt-3 text-xs text-plata">
                *Guardado local (este navegador). Exportar/Importar lo agrego después si lo querís.
              </p>
            </div>
          </div>
        </div>

        <!-- Nav -->
        <div class="flex flex-col gap-3 border-t border-white/10 pt-6 md:flex-row md:items-center md:justify-between">
          <div class="flex items-center gap-2 text-xs text-plata">
            <i class="fa-solid fa-circle-nodes"></i>
            <span>Flujo guiado · Semáforo en vivo · Registro ordenado</span>
          </div>

          <div class="flex flex-wrap items-center gap-3">
            <button id="btnPrev" type="button"
              class="rounded-2xl bg-white/5 px-5 py-3 text-sm font-semibold ring-1 ring-white/10 hover:bg-white/10 transition disabled:opacity-40 disabled:hover:bg-white/5">
              <i class="fa-solid fa-arrow-left mr-2"></i> Atrás
            </button>
            <button id="btnNext" type="button"
              class="rounded-2xl bg-rojo px-5 py-3 text-sm font-semibold shadow-glowRed hover:brightness-110 active:scale-[0.99] transition">
              Siguiente <i class="fa-solid fa-arrow-right ml-2"></i>
            </button>
          </div>
        </div>
      </form>
    </div>
  </section>

  <!-- Registro -->
  <section id="registro" class="mx-auto max-w-6xl px-4 pb-16">
    <div class="rounded-3xl bg-glass p-6 md:p-8 ring-1 ring-white/10 shadow-soft backdrop-blur-xl">
      <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div>
          <div class="text-sm text-plata">Base local (este navegador)</div>
          <div class="mt-1 text-2xl font-extrabold tracking-wide">Registro de Sujetos</div>
          <div class="mt-2 text-sm text-plata">Buscar · Cargar ficha · Imprimir · Eliminar</div>
        </div>

        <div class="flex flex-wrap items-center gap-2">
          <div class="relative">
            <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-plata"></i>
            <input id="searchInput" type="text" placeholder="Buscar por nombre o RUT…"
              class="w-72 max-w-[75vw] rounded-2xl bg-black/30 pl-10 pr-4 py-3 text-sm ring-1 ring-white/10 focus:ring-2 focus:ring-rojo outline-none transition">
          </div>

          <button id="btnWipeAll" type="button"
            class="rounded-2xl bg-rojo/20 px-4 py-3 text-sm font-semibold ring-1 ring-rojo/30 hover:bg-rojo/30 transition">
            <i class="fa-solid fa-trash-can mr-2"></i> Vaciar
          </button>
        </div>
      </div>

      <div class="mt-6 overflow-hidden rounded-3xl ring-1 ring-white/10">
        <div class="bg-black/30 p-4 text-xs text-plata flex items-center justify-between">
          <span id="countLabel">0 sujetos</span>
          <span class="hidden md:inline">Tip: guarda y después imprime desde registro si querís.</span>
        </div>

        <div class="overflow-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-white/5 text-plata">
              <tr>
                <th class="px-4 py-3 text-left">Fecha</th>
                <th class="px-4 py-3 text-left">Nombre</th>
                <th class="px-4 py-3 text-left">RUT</th>
                <th class="px-4 py-3 text-left">Riesgo</th>
                <th class="px-4 py-3 text-right">Acciones</th>
              </tr>
            </thead>
            <tbody id="registryBody" class="divide-y divide-white/10 bg-black/20"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <footer class="border-t border-white/10 bg-black/30 backdrop-blur-xl">
    <div class="mx-auto max-w-6xl px-4 py-8">
      <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div class="text-sm text-plata">
          <span class="font-semibold text-humo">ENTRENA'CHE</span> · Documento confidencial. No constituye diagnóstico médico.
        </div>
        <div class="text-xs text-plata">Ley 19.628 · Protección de la vida privada y datos personales.</div>
      </div>
    </div>
  </footer>

  <!-- Print Area Pro -->
  <div id="printArea" class="hidden">
    <div class="no-break" style="display:flex; justify-content:space-between; align-items:flex-start; gap:16px;">
      <div style="display:flex; align-items:center; gap:14px;">
        <img src="logo-entrenache.png" style="height:46px;">
        <div>
          <div class="print-title">ENTRENA'CHE</div>
          <div class="print-sub">Sistema de Evaluación Pre-participativa y Gestión de Riesgo</div>
        </div>
      </div>

      <div style="text-align:right;">
        <div class="print-label">Fecha</div>
        <div id="p_fecha" class="print-value">—</div>
      </div>
    </div>

    <div style="margin-top:10px;" class="print-sub">
      Ley 19.628 · Documento confidencial. No constituye diagnóstico médico.
    </div>

    <div style="margin-top:14px; display:grid; grid-template-columns: 1.2fr 0.8fr; gap:12px;" class="no-break">
      <div class="print-section">
        <div style="font-weight:800; margin-bottom:10px;">Datos del Sujeto</div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
          <div class="print-box">
            <div class="print-label">Nombre</div>
            <div id="p_nombre" class="print-value">—</div>
          </div>
          <div class="print-box">
            <div class="print-label">RUT</div>
            <div id="p_rut" class="print-value">—</div>
          </div>
          <div class="print-box">
            <div class="print-label">Edad</div>
            <div id="p_edad" class="print-value">—</div>
          </div>
          <div class="print-box">
            <div class="print-label">Contacto</div>
            <div id="p_contacto" class="print-value">—</div>
          </div>
        </div>

        <div style="margin-top:10px;" class="print-box">
          <div class="print-label">Notas / Observaciones</div>
          <div id="p_notas" style="font-size:10pt; line-height:1.35; margin-top:4px;">—</div>
        </div>
      </div>

      <div class="print-section">
        <div style="font-weight:800; margin-bottom:10px;">Evaluación de Riesgo</div>

        <div id="p_riskChip" class="chip chip-green">
        <div style="margin-top:10px;">
          <div style="height:8px; width:100%; background:#e5e7eb; border-radius:999px; overflow:hidden;">
            <div id="p_riskBar" style="height:100%; width:33%; background:#16A34A;"></div>
          </div>
        </div>
          <span id="p_riskDot" class="dot dot-green"></span>
          <span id="p_riskText">BAJO (VERDE)</span>
        </div>

        <div style="margin-top:10px;" class="print-box">
          <div class="print-label">Recomendación</div>
          <div id="p_decision" style="font-size:10pt; line-height:1.35; margin-top:4px;">—</div>
        </div>
      </div>
    </div>

    <div style="margin-top:12px; display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
      <div class="print-section no-break">
        <div style="font-weight:800; margin-bottom:10px;">Signos Vitales</div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
          <div class="print-box">
            <div class="print-label">PA (mmHg)</div>
            <div id="p_pa" class="print-value">—</div>
          </div>
          <div class="print-box">
            <div class="print-label">FCR (lpm)</div>
            <div id="p_fcr" class="print-value">—</div>
          </div>
          <div class="print-box">
            <div class="print-label">Peso (kg)</div>
            <div id="p_peso" class="print-value">—</div>
          </div>
          <div class="print-box">
            <div class="print-label">Estatura (cm)</div>
            <div id="p_estatura" class="print-value">—</div>
          </div>
        </div>
      </div>

      <div class="print-section no-break">
        <div style="font-weight:800; margin-bottom:10px;">Antecedentes / Contexto</div>
        <div class="print-box">
          <div class="print-label">Medicamentos crónicos</div>
          <div id="p_meds" class="print-value">—</div>
        </div>
        <div style="margin-top:10px;" class="print-box">
          <div class="print-label">Diagnóstico conocido</div>
          <div id="p_diag" class="print-value">—</div>
        </div>
        <div style="margin-top:10px;" class="print-box">
          <div class="print-label">Actividad / Objetivo</div>
          <div id="p_act_obj" style="font-size:10pt; line-height:1.35; margin-top:4px;">—</div>
        </div>
      </div>
    </div>

    <div style="margin-top:12px;" class="print-section no-break">
      <div style="font-weight:800; margin-bottom:10px;">Banderas</div>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
        <div class="print-box">
          <div class="print-label">Rojas</div>
          <div id="p_redFlags" style="font-size:10pt; line-height:1.35; margin-top:4px;">—</div>
        </div>
        <div class="print-box">
          <div class="print-label">Amarillas</div>
          <div id="p_yellowFlags" style="font-size:10pt; line-height:1.35; margin-top:4px;">—</div>
        </div>
      </div>
      <div style="margin-top:10px;" class="print-box">
        <div class="print-label">Detalle dolor</div>
        <div id="p_detalleDolor" style="font-size:10pt; line-height:1.35; margin-top:4px;">—</div>
      </div>
    </div>

    <div style="margin-top:14px; display:grid; grid-template-columns: 1fr 1fr; gap:18px;" class="no-break">
      <div><div class="sigline">Firma del Atleta</div></div>
      <div><div class="sigline">Firma del Preparador</div></div>
    </div>

    <div style="margin-top:10px; font-size:8.5pt; color:#555 !important;">
      *Registro de anamnesis pre-participativa. No reemplaza evaluación médica.
    </div>
  </div>

  <script>
    // ===== Helpers =====
    const $ = (id) => document.getElementById(id);
    const steps = Array.from(document.querySelectorAll(".step"));
    const STORAGE_KEY = "ENTRENACHE_REGISTRY_V2";

    const state = { step: 1, risk: "BAJO", riskColor: "GREEN" };

    function formatDateES(date = new Date()) {
      const d = String(date.getDate()).padStart(2, "0");
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const y = date.getFullYear();
      return `${d}/${m}/${y}`;
    }
    function nowISO(){ return new Date().toISOString(); }
    function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }

    function toast(msg, type="ok") {
      const el = document.createElement("div");
      el.className = "fixed bottom-5 left-1/2 -translate-x-1/2 z-50 max-w-[92vw] rounded-2xl px-4 py-3 text-sm ring-1 backdrop-blur-xl " +
        (type==="err" ? "bg-rojo/20 ring-rojo/30 shadow-glowRed text-red-100" : "bg-emerald-500/15 ring-emerald-500/25 shadow-glowGreen text-emerald-100");
      el.innerHTML = (type==="err" ? '<i class="fa-solid fa-circle-xmark mr-2"></i>' : '<i class="fa-solid fa-circle-check mr-2"></i>') + msg;
      document.body.appendChild(el);
      setTimeout(()=>el.remove(), 2200);
    }

    function scrollToId(id) {
      document.querySelector("#" + id).scrollIntoView({ behavior: "smooth", block: "start" });
    }

    // ===== Steps =====
    function showStep(n) {
      state.step = clamp(n, 1, 3);
      steps.forEach(s => s.classList.toggle("hidden", Number(s.dataset.step) !== state.step));
      const pct = state.step === 1 ? 33 : state.step === 2 ? 66 : 100;
      $("progressPct").textContent = `${pct}%`;
      $("progressBar").style.width = `${pct}%`;
      $("stepLabel").textContent =
        state.step === 1 ? "Paso 1 de 3 · Identidad" :
        state.step === 2 ? "Paso 2 de 3 · Signos Vitales y Antecedentes" :
                           "Paso 3 de 3 · Semáforo";
      $("btnPrev").disabled = state.step === 1;
      $("btnNext").classList.toggle("hidden", state.step === 3);
    }

    function goNext() {
      if (state.step === 1) {
        if (!$("nombre").value.trim() || !$("rut").value.trim() || !$("edad").value.trim()) {
          toast("Completa Nombre, RUT y Edad para continuar.", "err");
          return;
        }
      }
      showStep(state.step + 1);
      scrollToId("evaluacion");
    }
    function goPrev() {
      showStep(state.step - 1);
      scrollToId("evaluacion");
    }

    // ===== Risk =====
    function computeRisk() {
      const red = $("dolorPecho").checked || $("desmayos").checked;
      const yellow = $("dolorArticular").checked || $("medsCardio").checked;

      if (red) { state.risk = "ALTO"; state.riskColor = "RED"; }
      else if (yellow) { state.risk = "MEDIO"; state.riskColor = "YELLOW"; }
      else { state.risk = "BAJO"; state.riskColor = "GREEN"; }

      renderRiskCard();
    }

    function renderRiskCard() {
      const riskCard = $("riskCard");
      const riskTitle = $("riskTitle");
      const riskMsg = $("riskMsg");
      const riskIcon = $("riskIcon");
      const riskPill = $("riskPill");

      riskCard.classList.remove("shadow-glowRed","shadow-glowYellow","shadow-glowGreen");
      riskPill.className = "inline-flex items-center gap-2 rounded-full px-3 py-1 ring-1 text-sm font-semibold";

      if (state.riskColor === "RED") {
        riskCard.classList.add("shadow-glowRed");
        riskTitle.textContent = "ALTO";
        riskMsg.textContent = "Riesgo Alto: Se sugiere pase médico.";
        riskIcon.className = "fa-solid fa-triangle-exclamation text-rojo text-xl";
        riskPill.classList.add("bg-rojo/15","ring-rojo/25","text-red-200");
        riskPill.innerHTML = `<span class="h-2 w-2 rounded-full bg-rojo"></span> ROJO`;
      } else if (state.riskColor === "YELLOW") {
        riskCard.classList.add("shadow-glowYellow");
        riskTitle.textContent = "MEDIO";
        riskMsg.textContent = "Riesgo Medio: ajustar cargas y evaluar dolor/condición.";
        riskIcon.className = "fa-solid fa-circle-exclamation text-yellow-300 text-xl";
        riskPill.classList.add("bg-yellow-400/10","ring-yellow-400/25","text-yellow-200");
        riskPill.innerHTML = `<span class="h-2 w-2 rounded-full bg-yellow-300"></span> AMARILLO`;
      } else {
        riskCard.classList.add("shadow-glowGreen");
        riskTitle.textContent = "BAJO";
        riskMsg.textContent = "Apto para entrenamiento intenso.";
        riskIcon.className = "fa-solid fa-circle-check text-emerald-400 text-xl";
        riskPill.classList.add("bg-emerald-500/15","ring-emerald-500/25","text-emerald-200");
        riskPill.innerHTML = `<span class="h-2 w-2 rounded-full bg-emerald-400"></span> VERDE`;
      }
    }

    // ===== Payload / Print =====
    function getCurrentPayload() {
      return {
        id: (crypto.randomUUID ? crypto.randomUUID() : (Date.now()+"_"+Math.random().toString(16).slice(2))),
        createdAt: nowISO(),
        fecha: formatDateES(),
        nombre: $("nombre").value.trim(),
        rut: $("rut").value.trim(),
        edad: $("edad").value.trim(),
        contacto: $("contacto").value.trim(),
        notas: $("notas").value.trim(),
        vitals: {
          paSis: $("paSis").value.trim(),
          paDia: $("paDia").value.trim(),
          fcr: $("fcr").value.trim(),
          peso: $("peso").value.trim(),
          estatura: $("estatura").value.trim(),
        },
        antecedentes: {
          meds: $("meds").checked,
          diag: $("diag").checked,
          detalle: $("detalleAntecedente").value.trim(),
          actividad: $("actividad").value,
          objetivo: $("objetivo").value
        },
        flags: {
          dolorPecho: $("dolorPecho").checked,
          desmayos: $("desmayos").checked,
          dolorArticular: $("dolorArticular").checked,
          medsCardio: $("medsCardio").checked,
          detalleDolor: $("detalleDolor").value.trim()
        },
        risk: { level: state.risk, color: state.riskColor }
      };
    }

    function decisionFromPayload(p) {
      const redFlags = [
        p.flags.dolorPecho ? "Dolor de pecho al esfuerzo" : null,
        p.flags.desmayos ? "Mareos / desmayos" : null
      ].filter(Boolean);

      const yellowFlags = [
        p.flags.dolorArticular ? "Dolor óseo/articular" : null,
        p.flags.medsCardio ? "Meds presión/corazón" : null
      ].filter(Boolean);

      if (p.risk.color === "RED") {
        return `Banderas rojas detectadas (${redFlags.join(", ")}). Recomendación: suspender entrenamiento intenso y sugerir pase médico / evaluación clínica previa.`;
      }
      if (p.risk.color === "YELLOW") {
        const details = [
          yellowFlags.length ? `Banderas amarillas: ${yellowFlags.join(", ")}.` : "",
          p.flags.detalleDolor ? `Detalle molestia: ${p.flags.detalleDolor}.` : ""
        ].filter(Boolean).join(" ");
        return `${details} Recomendación: ajustar intensidad/volumen, priorizar técnica, control del dolor y progresión conservadora.`;
      }
      return "Sin banderas críticas reportadas. Recomendación: apto para entrenamiento intenso con progresión planificada y monitoreo habitual.";
    }

    function fillPrettyPrintFromPayload(p) {
      $("p_fecha").textContent = p.fecha || formatDateES();
      $("p_nombre").textContent = p.nombre || "—";
      $("p_rut").textContent = p.rut || "—";
      $("p_edad").textContent = p.edad || "—";
      $("p_contacto").textContent = p.contacto || "—";
      $("p_notas").textContent = p.notas || "—";

      const pa = (p.vitals.paSis && p.vitals.paDia) ? `${p.vitals.paSis}/${p.vitals.paDia}` : "—";
      $("p_pa").textContent = pa;
      $("p_fcr").textContent = p.vitals.fcr || "—";
      $("p_peso").textContent = p.vitals.peso || "—";
      $("p_estatura").textContent = p.vitals.estatura || "—";

      $("p_meds").textContent = p.antecedentes.meds ? "Sí" : "No";
      $("p_diag").textContent = p.antecedentes.diag ? "Sí" : "No";
      $("p_act_obj").textContent = `Actividad: ${p.antecedentes.actividad || "—"} · Objetivo: ${p.antecedentes.objetivo || "—"}`;

      const redFlags = [
        p.flags.dolorPecho ? "Dolor de pecho al esfuerzo" : null,
        p.flags.desmayos ? "Mareos / desmayos" : null
      ].filter(Boolean);

      const yellowFlags = [
        p.flags.dolorArticular ? "Dolor óseo/articular" : null,
        p.flags.medsCardio ? "Meds presión/corazón" : null
      ].filter(Boolean);

      $("p_redFlags").textContent = redFlags.length ? redFlags.join(" · ") : "No reportadas";
      $("p_yellowFlags").textContent = yellowFlags.length ? yellowFlags.join(" · ") : "No reportadas";
      $("p_detalleDolor").textContent = p.flags.detalleDolor || "—";

      $("p_decision").textContent = decisionFromPayload(p);

      const chip = $("p_riskChip");
      const dot = $("p_riskDot");
      const txt = $("p_riskText");

      chip.className = "chip";
      dot.className = "dot";

      if (p.risk.color === "RED") {
        chip.classList.add("chip-red"); dot.classList.add("dot-red"); txt.textContent = "ALTO (ROJO)";
      } else if (p.risk.color === "YELLOW") {
        chip.classList.add("chip-yellow"); dot.classList.add("dot-yellow"); txt.textContent = "MEDIO (AMARILLO)";
      } else {
        chip.classList.add("chip-green"); dot.classList.add("dot-green"); txt.textContent = "BAJO (VERDE)";
      }
    }

    // ===== Storage / Registry =====
    function loadRegistry() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch { return []; }
    }
    function saveRegistry(arr) { localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }

    function renderRegistry() {
      const q = ($("searchInput").value || "").trim().toLowerCase();
      const reg = loadRegistry();
      const filtered = reg.filter(r => {
        const name = (r.nombre || "").toLowerCase();
        const rut = (r.rut || "").toLowerCase();
        return !q || name.includes(q) || rut.includes(q);
      });

      $("countLabel").textContent = `${filtered.length} sujeto${filtered.length===1?"":"s"}`;

      const tbody = $("registryBody");
      tbody.innerHTML = "";

      filtered.forEach(r => {
        const riskChip = r.risk.color === "RED"
          ? `<span class="inline-flex items-center gap-2 rounded-full bg-rojo/15 px-3 py-1 ring-1 ring-rojo/25 text-red-200 font-semibold text-xs"><span class="h-2 w-2 rounded-full bg-rojo"></span> ALTO</span>`
          : r.risk.color === "YELLOW"
          ? `<span class="inline-flex items-center gap-2 rounded-full bg-yellow-400/10 px-3 py-1 ring-1 ring-yellow-400/25 text-yellow-200 font-semibold text-xs"><span class="h-2 w-2 rounded-full bg-yellow-300"></span> MEDIO</span>`
          : `<span class="inline-flex items-center gap-2 rounded-full bg-emerald-500/15 px-3 py-1 ring-1 ring-emerald-500/25 text-emerald-200 font-semibold text-xs"><span class="h-2 w-2 rounded-full bg-emerald-400"></span> BAJO</span>`;

        const tr = document.createElement("tr");
        tr.className = "hover:bg-white/5 transition";
        tr.innerHTML = `
          <td class="px-4 py-3 text-plata whitespace-nowrap">${r.fecha || "—"}</td>
          <td class="px-4 py-3 font-semibold">${r.nombre || "—"}</td>
          <td class="px-4 py-3 text-plata">${r.rut || "—"}</td>
          <td class="px-4 py-3">${riskChip}</td>
          <td class="px-4 py-3 text-right">
            <button data-act="load" data-id="${r.id}"
              class="rounded-xl bg-white/5 px-3 py-2 text-xs font-semibold ring-1 ring-white/10 hover:bg-white/10 transition">
              <i class="fa-solid fa-arrow-up-right-from-square mr-2"></i>Cargar
            </button>
            <button data-act="print" data-id="${r.id}"
              class="ml-2 rounded-xl bg-white/5 px-3 py-2 text-xs font-semibold ring-1 ring-white/10 hover:bg-white/10 transition">
              <i class="fa-solid fa-print mr-2"></i>Imprimir
            </button>
            <button data-act="del" data-id="${r.id}"
              class="ml-2 rounded-xl bg-rojo/20 px-3 py-2 text-xs font-semibold ring-1 ring-rojo/30 hover:bg-rojo/30 transition">
              <i class="fa-solid fa-trash-can mr-2"></i>Eliminar
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function getById(id) { return loadRegistry().find(r => r.id === id); }

    function setFormFromPayload(p) {
      $("nombre").value = p.nombre || "";
      $("rut").value = p.rut || "";
      $("edad").value = p.edad || "";
      $("contacto").value = p.contacto || "";
      $("notas").value = p.notas || "";

      $("paSis").value = p.vitals?.paSis || "";
      $("paDia").value = p.vitals?.paDia || "";
      $("fcr").value = p.vitals?.fcr || "";
      $("peso").value = p.vitals?.peso || "";
      $("estatura").value = p.vitals?.estatura || "";

      $("meds").checked = !!p.antecedentes?.meds;
      $("diag").checked = !!p.antecedentes?.diag;
      $("detalleAntecedente").value = p.antecedentes?.detalle || "";
      $("actividad").value = p.antecedentes?.actividad || "";
      $("objetivo").value = p.antecedentes?.objetivo || "";

      $("dolorPecho").checked = !!p.flags?.dolorPecho;
      $("desmayos").checked = !!p.flags?.desmayos;
      $("dolorArticular").checked = !!p.flags?.dolorArticular;
      $("medsCardio").checked = !!p.flags?.medsCardio;
      $("detalleDolor").value = p.flags?.detalleDolor || "";

      computeRisk();
    }

    // ===== Actions =====
    function saveCurrent() {
      if (!$("nombre").value.trim() || !$("rut").value.trim() || !$("edad").value.trim()) {
        toast("Completa Nombre, RUT y Edad antes de guardar.", "err");
        return;
      }
      const payload = getCurrentPayload();
      const reg = loadRegistry();
      reg.unshift(payload);
      saveRegistry(reg);
      renderRegistry();
      toast("Guardado en registro.");
      scrollToId("registro");
    }

    function printCurrentFromForm() {
      if (!$("nombre").value.trim() || !$("rut").value.trim() || !$("edad").value.trim()) {
        toast("Completa al menos Nombre, RUT y Edad para imprimir.", "err");
        return;
      }
      const payload = getCurrentPayload();
      fillPrettyPrintFromPayload(payload);
      window.print();
    }

    function resetAll() {
      $("anamnesisForm").reset();
      computeRisk();
      showStep(1);
      toast("Formulario reiniciado.");
      scrollToId("evaluacion");
    }

    // ===== Init =====
    (function init() {
      $("fechaHoy").textContent = formatDateES();
      computeRisk();
      showStep(1);
      renderRegistry();

      $("btnNext").addEventListener("click", goNext);
      $("btnPrev").addEventListener("click", goPrev);
      $("btnReset").addEventListener("click", resetAll);

      $("btnStart").addEventListener("click", () => scrollToId("evaluacion"));
      $("btnScrollStart").addEventListener("click", () => scrollToId("evaluacion"));
      $("btnGoRegistro").addEventListener("click", () => scrollToId("registro"));

      ["dolorPecho","desmayos","dolorArticular","medsCardio"].forEach(id => $(id).addEventListener("change", computeRisk));

      $("btnSave").addEventListener("click", saveCurrent);
      $("btnPrint").addEventListener("click", printCurrentFromForm);

      $("searchInput").addEventListener("input", renderRegistry);

      $("btnWipeAll").addEventListener("click", () => {
        const ok = confirm("¿Seguro que quieres vaciar TODO el registro local?");
        if (!ok) return;
        localStorage.removeItem(STORAGE_KEY);
        renderRegistry();
        toast("Registro vaciado.");
      });

      $("registryBody").addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-act]");
        if (!btn) return;
        const act = btn.dataset.act;
        const id = btn.dataset.id;
        const rec = getById(id);
        if (!rec) return;

        if (act === "load") {
          setFormFromPayload(rec);
          showStep(3);
          toast("Ficha cargada.");
          scrollToId("evaluacion");
        } else if (act === "print") {
          fillPrettyPrintFromPayload(rec);
          window.print();
        } else if (act === "del") {
          const reg = loadRegistry().filter(r => r.id !== id);
          saveRegistry(reg);
          renderRegistry();
          toast("Registro eliminado.");
        }
      });

      $("btnDemoFill").addEventListener("click", () => {
        $("nombre").value = "Matías Flores";
        $("rut").value = "12.345.678-9";
        $("edad").value = "25";
        $("contacto").value = "+56 9 1234 5678";
        $("notas").value = "Objetivo: fuerza/hipertrofia. Molestia ocasional en rodilla.";

        $("paSis").value = "120";
        $("paDia").value = "78";
        $("fcr").value = "58";
        $("peso").value = "78.5";
        $("estatura").value = "176";
        $("actividad").value = "Entrena 3-4 días/sem";
        $("objetivo").value = "Fuerza / Powerbuilding";

        $("dolorArticular").checked = true;
        $("detalleDolor").value = "Rodilla derecha (sentadilla profunda).";

        computeRisk();
        toast("Demo cargada.");
        showStep(3);
        scrollToId("evaluacion");
      });
    })();
  </script>
</body>
</html>

